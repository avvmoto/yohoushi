#!/usr/bin/env ruby
require 'bundler/setup'
require 'yaml'
ENV['RAILS_ENV'] ||= 'development'
Bundler.require(:bin, ENV['RAILS_ENV'])

module YohoushiWorker
  class CLI < Thor
    class_option :config,    :aliases => ["-c"], :type => :string, :default => 'config/worker.yml'

    def initialize(args = [], opts = [], config = {})
      super(args, opts, config)

      if options[:config] && File.exists?(options[:config])
        @options = YAML.load_file(options[:config])[ENV['RAILS_ENV']].merge(@options)
      end
    end

    desc "start", "Start processing jobs."
    option :require,     :aliases => ["-r"], :type => :string
    option :daemonize,   :aliases => ["-d"], :type => :boolean
    option :interval,    :aliases => ["-i"], :type => :numeric
    # serverengine options
    option :log,         :aliases => ["-l"], :type => :string
    option :pid_path,    :aliases => ["-p"], :type => :string
    option :log_stdout,                      :type => :boolean
    option :log_stderr,                      :type => :boolean
    def start
      Bundler.require(:worker, ENV['RAILS_ENV'])
      load_enviroment(options[:require]) # load rails only in start
      opts = @options.symbolize_keys.except(:require, :config, :interval)

      se = ServerEngine.create(nil, Worker, opts)
      se.run
    end

    desc "stop", "Stops a worker"
    option :pid_path,    :aliases => ["-p"], :type => :string
    def stop
      pid = File.read(@options["pid_path"]).to_i

      begin
        Process.kill("QUIT", pid)
        puts "Stopped #{pid}"
      rescue Errno::ESRCH
        puts "Worker #{pid} not running"
      end
    end

    desc "graceful_stop", "Gracefully stops a worker"
    option :pid_path,    :aliases => ["-p"], :type => :string
    def graceful_stop
      pid = File.read(@options["pid_path"]).to_i

      begin
        Process.kill("TERM", pid)
        puts "Gracefully stopped #{pid}"
      rescue Errno::ESRCH
        puts "Worker #{pid} not running"
      end
    end

    desc "restart", "Restarts a worker"
    option :pid_path,    :aliases => ["-p"], :type => :string
    def restart
      pid = File.read(@options["pid_path"]).to_i

      begin
        Process.kill("HUP", pid)
        puts "Restarted #{pid}"
      rescue Errno::ESRCH
        puts "Worker #{pid} not running"
      end
    end

    desc "graceful_restart", "Graceful restarts a worker"
    option :pid_path,    :aliases => ["-p"], :type => :string
    def graceful_restart
      pid = File.read(@options["pid_path"]).to_i

      begin
        Process.kill("USR1", pid)
        puts "Gracefully restarted #{pid}"
      rescue Errno::ESRCH
        puts "Worker #{pid} not running"
      end
    end

    protected

      def load_enviroment(file = nil)
        file ||= "."
        if File.directory?(file) && File.exists?(File.expand_path("#{file}/config/environment.rb"))
          require "rails"
          require File.expand_path("#{file}/config/environment.rb")
          if defined?(::Rails) && ::Rails.respond_to?(:application)
            # Rails 3
            ::Rails.application.eager_load!
          elsif defined?(::Rails::Initializer)
            # Rails 2.3
            $rails_rake_task = false
            ::Rails::Initializer.run :load_application_classes
          end
        elsif File.file?(file)
          require File.expand_path(file)
        end
      end

  end
end

YohoushiWorker::CLI.start(ARGV)
